name: Daily Paper Update

on:
  # Run daily at midnight UTC (so tomorrow's papers are ready when the day starts)
  schedule:
    - cron: '0 0 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  update-papers:
    runs-on: ubuntu-latest

    permissions:
      contents: write       # Allow pushing commits
      issues: write         # Allow creating issues on failure

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Run data ingestion for tomorrow
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SEMANTIC_SCHOLAR_API_KEY: ${{ secrets.SEMANTIC_SCHOLAR_API_KEY }}
        run: |
          # Calculate tomorrow's date
          TOMORROW=$(date -d '+1 day' +%m-%d)
          python scripts/ingest_recent.py $TOMORROW

      - name: Generate JSON files for tomorrow
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          # Calculate tomorrow's date
          TOMORROW=$(date -d '+1 day' +%m-%d)
          python scripts/generate_json.py $TOMORROW

      - name: Commit and push if changes
        run: |
          git config --global user.name 'Paper Birthday Bot'
          git config --global user.email 'bot@paperbirthdays.com'
          git add public/data/*.json

          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            TOMORROW=$(date -d '+1 day' +'%Y-%m-%d')
            git commit -m "Update paper data for ${TOMORROW} (tomorrow)

            ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Daily Update Failed - ' + new Date().toISOString().split('T')[0],
              body: 'The daily paper update workflow failed. Check the [workflow logs](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions) for details.',
              labels: ['automated', 'bug']
            })
